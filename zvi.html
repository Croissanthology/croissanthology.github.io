<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>zviquote</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Cambria, Georgia, serif;
            background: #fdf6e3;
            color: #1a1a1a;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
        }
        
        h1 {
            color: #8e81a2;
            font-size: 4em;
            font-weight: 400;
            margin-bottom: 60px;
        }
        
        .progress-container {
            width: 400px;
            height: 12px;
            background: #e8e0d0;
            border-radius: 6px;
            overflow: hidden;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .progress-container.visible {
            opacity: 1;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #c29969, #8e81a2);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .status {
            margin-top: 25px;
            color: #c29969;
            font-size: 1.2em;
            min-height: 30px;
        }
        
        .success {
            color: #8e81a2;
            font-weight: 600;
        }
        
        .error {
            color: #d33;
        }
        
        .debug {
            margin-top: 30px;
            padding: 15px;
            background: #fff;
            border: 1px solid #e8e0d0;
            border-radius: 4px;
            max-width: 600px;
            font-size: 0.85em;
            color: #666;
            max-height: 200px;
            overflow: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <h1>zviquote</h1>
    
    <div class="progress-container" id="progressContainer">
        <div class="progress-bar" id="progressBar"></div>
    </div>
    
    <div id="status" class="status">paste your draft (ctrl+v)</div>
    
    <div id="debug" class="debug" style="display: none;"></div>

    <script>
        const nitterInstances = [
            'nitter.poast.org',
            'nitter.privacydev.net',
            'nitter.net'
        ];
        
        let currentNitterIndex = 0;
        let isProcessing = false;

        function getNitterUrl(tweetUrl) {
            const match = tweetUrl.match(/(?:twitter\.com|x\.com)\/([^\/]+)\/status\/(\d+)/);
            if (!match) return null;
            
            const [, username, tweetId] = match;
            const nitterDomain = nitterInstances[currentNitterIndex];
            return `https://${nitterDomain}/${username}/status/${tweetId}`;
        }

        async function fetchTweetData(xUrl) {
            const nitterUrl = getNitterUrl(xUrl);
            if (!nitterUrl) return null;

            try {
                const response = await fetch(nitterUrl);
                if (!response.ok) throw new Error('fetch failed');
                
                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                const tweetText = doc.querySelector('.tweet-content')?.innerText?.trim() || '';
                const username = doc.querySelector('.fullname')?.innerText?.trim() || 
                                doc.querySelector('.username')?.innerText?.trim()?.replace('@', '') || 'Unknown';
                
                return {
                    text: tweetText,
                    username: username,
                    xUrl: xUrl
                };
            } catch (error) {
                if (currentNitterIndex < nitterInstances.length - 1) {
                    currentNitterIndex++;
                    return fetchTweetData(xUrl);
                }
                return null;
            }
        }

        function formatTweetAsMarkdown(tweetData) {
            return `> **[${tweetData.username}:](${tweetData.xUrl})** ${tweetData.text}`;
        }

        function findNakedLinks(text) {
            const urlRegex = /https?:\/\/(?:twitter\.com|x\.com)\/[^\s<>"]+\/status\/\d+/g;
            return [...new Set(text.match(urlRegex) || [])];
        }

        async function processText(text, onProgress) {
            const nakedLinks = findNakedLinks(text);
            
            if (nakedLinks.length === 0) {
                return null;
            }

            const batchSize = 6;
            const batches = [];
            for (let i = 0; i < nakedLinks.length; i += batchSize) {
                batches.push(nakedLinks.slice(i, i + batchSize));
            }

            const urlToMarkdown = new Map();
            let processed = 0;

            for (const batch of batches) {
                const promises = batch.map(url => fetchTweetData(url));
                const results = await Promise.all(promises);
                
                results.forEach((tweetData, index) => {
                    const url = batch[index];
                    if (tweetData) {
                        urlToMarkdown.set(url, formatTweetAsMarkdown(tweetData));
                    }
                    processed++;
                    onProgress(processed / nakedLinks.length);
                });
            }

            let result = text;
            urlToMarkdown.forEach((markdown, url) => {
                const escapedUrl = url.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                result = result.replace(new RegExp(escapedUrl, 'g'), markdown);
            });

            return result;
        }

        const status = document.getElementById('status');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const debugDiv = document.getElementById('debug');

        document.addEventListener('paste', async (e) => {
            if (isProcessing) return;
            
            e.preventDefault();
            
            const clipboardData = e.clipboardData || window.clipboardData;
            const html = clipboardData.getData('text/html');
            const plain = clipboardData.getData('text/plain');
            
            // Debug: show what we got
            debugDiv.style.display = 'block';
            debugDiv.textContent = `HTML: ${html ? 'YES (' + html.length + ' chars)' : 'NO'}\nPlain: ${plain ? 'YES (' + plain.length + ' chars)' : 'NO'}\n\nFirst 500 chars:\n${(html || plain).substring(0, 500)}`;
            
            const content = html || plain;
            
            if (!content || !content.match(/https?:\/\/(?:twitter\.com|x\.com)/)) {
                status.textContent = 'no x.com links found';
                status.className = 'status error';
                return;
            }

            isProcessing = true;
            status.textContent = 'fetching tweets...';
            status.className = 'status';
            progressContainer.classList.add('visible');
            progressBar.style.width = '0%';
            currentNitterIndex = 0;

            try {
                const result = await processText(content, (progress) => {
                    progressBar.style.width = (progress * 100) + '%';
                });
                
                if (!result) {
                    status.textContent = 'no naked links found';
                    status.className = 'status error';
                    progressContainer.classList.remove('visible');
                    isProcessing = false;
                    return;
                }
                
                // Copy to clipboard
                await navigator.clipboard.writeText(result);
                
                status.textContent = 'copied - paste back';
                status.className = 'status success';
                progressBar.style.width = '100%';
                
                setTimeout(() => {
                    progressContainer.classList.remove('visible');
                    status.textContent = 'paste your draft (ctrl+v)';
                    status.className = 'status';
                    debugDiv.style.display = 'none';
                }, 4000);
                
            } catch (error) {
                status.textContent = 'error: ' + error.message;
                status.className = 'status error';
                progressContainer.classList.remove('visible');
            } finally {
                isProcessing = false;
            }
        });
    </script>
</body>
</html>
